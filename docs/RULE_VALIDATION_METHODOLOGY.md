# 规则验证方法论

基于 XML 命名空间验证的经验，建立的规则验证标准方法。

---

## 🎯 **验证目标**

确保规则的实现与其意图相符，避免：
- ❌ 假阳性（false positives）- 不应该匹配的代码被标记
- ❌ 假阴性（false negatives）- 应该匹配的代码没有被标记
- ❌ 边界情况处理不当

---

## 📋 **验证步骤**

### 第 1 步：理解规则意图

**问题：** 这个规则想要检测什么？

**方法：**
- 阅读规则的 `name` 和 `description`
- 理解规则的 `message` 和 `fix`
- 确定规则的适用场景

**示例（XML 命名空间）：**
```
规则意图：检测使用了默认命名空间的元素
建议：改为使用显式的前缀命名空间
```

---

### 第 2 步：分析测试代码

**问题：** 测试代码中哪些应该匹配，哪些不应该？

**方法：**
- 查看代码中的注释（如 `//ruleid:` 或 `//OK:`）
- 识别应该被检测的代码片段
- 识别不应该被检测的代码片段
- 列出所有边界情况

**示例（Java System.out）：**
```java
// 应该匹配
System.out.println("Debug: Processing user data");  // ✅
System.err.print("Warning: ");                       // ✅

// 不应该匹配
//System.err.print("Warning: ");                     // ❌ 注释中
logger.info("Processing user data");                 // ❌ 使用了日志框架
```

---

### 第 3 步：检查实际结果

**问题：** 规则实际检测到了什么？

**方法：**
```bash
astgrep analyze --language <lang> --rules <rule.yaml> <code.file>
```

**分析输出：**
- 检查发现的行号
- 检查发现的消息
- 检查发现的数量

---

### 第 4 步：对比预期

**问题：** 实际结果与预期是否一致？

**方法：**
创建对比表格：

| 行号 | 代码 | 预期 | 实际 | 符合预期 |
|------|------|------|------|---------|
| 4 | `System.out.println(...)` | ✅ | ✅ | ✅ |
| 8 | `//System.err.print(...)` | ❌ | ❌ | ✅ |

---

### 第 5 步：识别问题

**问题：** 如果有不符合预期的地方，原因是什么？

**方法：**
- 分析规则的模式
- 检查模式是否正确
- 考虑是否需要改进规则

**示例（XML 注释）：**
```
问题：规则匹配了所有注释，包括正常的注释
原因：正则表达式 <!--[^-]*--[^-] 会匹配 -->
解决：改为 <!--[^-]*--[^->]
```

---

## 📊 **验证报告模板**

```markdown
## 规则: [规则名称]

### 规则意图
[描述规则想要检测什么]

### 预期匹配
| 行号 | 代码 | 原因 |
|------|------|------|
| ... | ... | ... |

### 预期不匹配
| 行号 | 代码 | 原因 |
|------|------|------|
| ... | ... | ... |

### 实际结果
[运行规则的输出]

### 对比分析
| 项目 | 预期 | 实际 | 符合 |
|------|------|------|------|
| 总发现数 | X | Y | ✅/❌ |
| 假阳性 | 0 | Z | ✅/❌ |
| 假阴性 | 0 | W | ✅/❌ |

### 结论
[规则是否符合预期]
```

---

## ✅ **验证清单**

- [ ] 理解规则意图
- [ ] 分析测试代码中的所有情况
- [ ] 运行规则并收集结果
- [ ] 创建对比表格
- [ ] 检查是否有假阳性
- [ ] 检查是否有假阴性
- [ ] 分析任何不符合预期的地方
- [ ] 记录结论

---

## 📈 **验证指标**

| 指标 | 目标 | 说明 |
|------|------|------|
| 假阳性率 | 0% | 不应该匹配的代码不被标记 |
| 假阴性率 | 0% | 应该匹配的代码都被标记 |
| 准确性 | 100% | 所有预期都符合 |
| 边界情况 | 100% | 所有边界情况都处理正确 |

---

## 🎓 **案例研究**

### 案例 1：XML 命名空间验证

**问题发现：** 规则匹配了所有 XML 注释  
**原因分析：** 正则表达式模式不正确  
**解决方案：** 改进正则表达式  
**结果：** 假阳性从 78 个降到 0 个  

### 案例 2：Java 规则验证

**问题发现：** 无  
**结果：** 所有规则都符合预期，准确性 100%  

---

## 🚀 **最佳实践**

1. **始终创建测试代码** - 包含应该匹配和不应该匹配的情况
2. **使用注释标记预期** - 使用 `//ruleid:` 和 `//OK:` 标记
3. **系统地验证** - 不要跳过任何情况
4. **记录结果** - 创建验证报告
5. **定期审查** - 当规则改变时重新验证

---

## 📝 **相关文档**

- [XML 命名空间验证分析](./XML_NAMESPACE_VALIDATION_ANALYSIS.md)
- [Java 规则验证分析](./JAVA_RULES_VALIDATION_ANALYSIS.md)

